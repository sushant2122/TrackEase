@page "/transaction"
@using TrackEase.Models;

<head>
    <link rel="stylesheet" href="css/Transaction.css" />
</head>

<h1><b>Transaction</b></h1>

<!-- Search Bar and Date Filter -->

<div class="search-filter-container">
    <div class="search-bar">
        <input type="text" @bind="searchTitle"
               class="form-control"
               id="searchInput"
               placeholder="Search by title, type, or tag..." />
    </div>
    <div class="type-filter">
        <label for="typeFilter">Type:</label>
        <select class="form-control" id="typeFilter" @bind="selectedType">
            <option value="">All</option>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
            <option value="Debt">Debt</option>
        </select>
    </div>
    <div class="date-filter">
        <label for="startDate">Start Date:</label>
        <input type="date" class="form-control" @bind="startDate" id="startDate" />

        <label for="endDate">End Date:</label>
        <input type="date" class="form-control" @bind="endDate" id="endDate" />

        <button class="btn filter-button" @onclick="ApplyFilters">Filter</button>
    </div>
</div>

<!-- Transactions Table -->
<div class="mt-5">
    <table class="table">
        <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Tag</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Type</th>
            <th>Notes</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="transactionTable">
        @if (FilteredTransactions().Any())
        {
            @foreach (var transaction in FilteredTransactions())
            {
                <tr>
                    <td>@transaction.Title</td>
                    <td>@transaction.Description</td>
                    <td><span>@transaction.TagName</span></td>
                    <td>@transaction.Date.ToString("yyyy-MM-dd")</td>
                    <td>@transaction.Amount</td>
                    <td>
                        <span class="@(transaction.Type == "Debt" ? "text-warning" :
                                     transaction.Type == "Expense" ? "text-danger" :
                                     transaction.Type == "Income" ? "text-success" : "")">
                            @transaction.Type
                        </span>
                    </td>
                    <td>@transaction.Notes</td>
                    <td>
                        <button type="button" class="update-button" @onclick="() => OpenEditPopup(transaction.Id)">Edit</button>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="7">No transactions found.</td>
            </tr>
        }
        </tbody>
    </table>
</div>
<!-- Popup Modal -->
@if (showEditPopup)
{
    <div class="modal-overlay">
        <div class="modal fade show">
            <div class="modal-dialog custom-modal-width"> <!-- Custom width applied -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Transaction Note</h5>
                        <button type="button" class="close" @onclick="CloseEditPopup">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="note">Add Note:</label>
                                <textarea id="note" class="form-control" @bind="note" placeholder="Enter your note here..."></textarea>
                            </div>
                            <div class="form-group text-right">
                                <button type="button" class="btn btn-primary" @onclick="SubmitNote">Submit</button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseEditPopup">Cancel</button>
                            </div>
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="text-danger">@errorMessage</div>
                            }
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Custom Tag -->
<div class="mt-5 flex1">
    <h3><b>Add Custom Tag</b></h3>
    <form id="customTagForm" @onsubmit="HandleTagSubmit">
        <div class="form-group">
            <div class="mb-3">
                <label for="custom_tag"><b>Custom Tag Title:</b></label>
                <input type="text" @bind="newTag.TagName" class="form-control" id="custom_tag" placeholder="Enter a custom tag" required />
            </div>
            <div class="mb-3">
                <label>Type</label>
                <select class="form-control" @bind="newTag.TagType">
                    <option value=""></option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn update-button mt-3">Add Tag</button>
    </form>
</div>

<!-- Tags Table -->
<div class="mt-5">
    <table class="table">
        <thead>
        <tr>
            <th>S.N</th>
            <th>Tag Name</th>
            <th>Tag Type</th>
        </tr>
        </thead>
        <tbody id="tagTable">
            @if (tags.Any())
            {
                @foreach (var tag in tags)
                {
                    <tr>
                        <td>@tag.Id</td>
                        <td>@tag.TagName</td>
                        <td>@tag.TagType</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="2">No tags found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private bool showEditPopup = false;
    private int selectedTransactionId;
    private string note = string.Empty;
    private string selectedType;
    private List<Models.Transaction> transactions = new();
    private List<Tag> tags = new();
    private Tag newTag = new();
    private string searchTitle;
    private DateTime? startDate;
    private DateTime? endDate;
    private string? errorMessage;
   
    protected override async Task OnInitializedAsync()
    {
        try
        {
            transactions = await TransactionSerive.GetAllTransactions();
            tags = TagService.GetAllTags();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing data: {ex.Message}");
        }
    }
    
    private void OpenEditPopup(int transactionId)
    {
        selectedTransactionId = transactionId;
        var transaction = transactions.FirstOrDefault(t => t.Id == transactionId);
        note = transaction?.Notes ?? string.Empty;
        showEditPopup = true;
    }
    private void CloseEditPopup()
    {
        showEditPopup = false;
        note = string.Empty;
        selectedTransactionId = 0;
        errorMessage = string.Empty;
    }
    // Function to submit the note for the selected transaction
    private async Task SubmitNote()
    {
        try
        {
            // Find the transaction to update
            var transactionToUpdate = transactions.FirstOrDefault(t => t.Id == selectedTransactionId);
            if (transactionToUpdate == null)
            {
                // Transaction not found
                Console.WriteLine("Transaction not found.");
                return;
            }

            // Update the Notes field
            transactionToUpdate.Notes = note;

            // Call the service to update the transaction
            var updateResult = await TransactionSerive.UpdateTransaction(transactionToUpdate);

            if (updateResult)
            {
                // Success: Refresh the transaction list and close the modal
                Console.WriteLine("Note updated successfully.");
                transactions = await TransactionSerive.GetAllTransactions();
                CloseEditPopup();
            }
            else
            {
                // Failure: Handle appropriately
                Console.WriteLine("Failed to update the note.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating note: {ex.Message}");
        }
    }

    private IEnumerable<Models.Transaction> FilteredTransactions()
    {
        return transactions.Where(t =>
            (string.IsNullOrEmpty(searchTitle) || 
             t.Title.Contains(searchTitle, StringComparison.OrdinalIgnoreCase) || 
             (!string.IsNullOrEmpty(t.TagName) && t.TagName.Contains(searchTitle, StringComparison.OrdinalIgnoreCase))) &&
            (string.IsNullOrEmpty(selectedType) || t.Type.Equals(selectedType, StringComparison.OrdinalIgnoreCase)) &&
            (!startDate.HasValue || t.Date >= startDate) &&
            (!endDate.HasValue || t.Date <= endDate));
    }

    private void ApplyFilters()
    {
        StateHasChanged();
    }

    private void HandleTagSubmit()
    {
        try
        {
            if (TagService.AddTag(newTag))
            {
                newTag = new Tag(); // Reset form
                tags = TagService.GetAllTags(); // Refresh the tags list
                Console.WriteLine("Tag added successfully!");
            }
            else
            {
                Console.WriteLine("Failed to add tag. Duplicate or invalid input.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding tag: {ex.Message}");
        }
    }
}
